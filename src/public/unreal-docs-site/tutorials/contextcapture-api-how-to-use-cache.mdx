export const metadata = {
  title: 'Using cache in ContextCapture API',
  tile: {
    name: 'Using cache in ContextCapture API',
    description:
      'This tutorial focuses on using cache for faster processing in ContextCapture',
    thumbnail: '/images/cccs-cache-thumb.png',
    href: '/tutorials/contextcapture-api-how-to-use-cache/',
    durationInMinutes: 15,
    relatedApiIds: ['contextcapture'],
  },
};

<Introduction
  skillLevel="Advanced"
  durationInMinutes="15"
  summaryImageSrc="/unreal-docs-site/images/cccs-cache-header.jpg"
>

## Introduction

The goal of this tutorial is to leverage the caching mechanism of _ContextCapture REST API_ in order to speed up your processing.

In this tutorial, we will create a job to be cached, then use this cache to export another format without reprocessing the complete data.

</Introduction>

<TutorialSection>

## Prerequisites

This tutorial assumes that you already have:

- Completed the [ContextCapture Quick Start tutorial](/tutorials/contextcapture-api-quick-start):
  - [Created a workspace](/tutorials/contextcapture-api-quick-start/#3-create-a-workspace)
  - Uploaded input data (images and orientations)

</TutorialSection>

<TutorialSection>

## 1. Cache re-usage and behavior

### Cache re-usage

Before creating jobs, it is important to understand how caching works in _ContextCapture_.
When asked for, a cache will be created if the job is successful. If a job is failed or cancelled, no cache will be created.

A created cache can be used for later jobs in order to reuse it (new exports for example). This is the table of possible workflows:

|                | Cached Calibration | Cached Reconstruction | Cached Full |
| -------------: | :----------------: | :-------------------: | :---------: |
|    Calibration |         ✔️         |          ❌           |     ✔️      |
| Reconstruction |         ✔️         |          ✔️           |     ✔️      |
|           Full |         ✔️         |          ❌️          |     ✔️      |

A new calibration job based on a cached reconstruction will failed for example.

### Cache behavior

_ContextCapture_ considers that cache is the truth, and will use it as much as possible.
For example, if you submit a full job with a _Draft_ mesh quality to produce a 3MX, then use it as cache for a full job with _Extra_ mesh quality to produce an OBJ, you will have a _Draft_ OBJ result.

Caches are standalone snapshot of a job. They don't depend on each other. Note that for large projects, cache can be very large:

- Cache upload will then slow marginally your job
- Usage of Reality Data will increase

Cache can be cleaned: they are uploaded in the _ContextCapture_ workspace reality data on _Reality Data_ - reality data id is the workspace id, in `{JOB_ID}/cache`.

</TutorialSection>

<TutorialSection>

## 2. Create a job that will be cache

In order to tell _ContextCapture_ we want to create a cache of the job, we just need to specify a setting in the job creation payload.

</TutorialSection>

<TutorialSection
  subSection={true}
  actions={[
    <CodeBlock language='http' code={`POST https://api.bentley.com/contextcapture/jobs HTTP/1.1
Authorization: Bearer JWT_TOKEN
Content-Type: application/json`}/>
  ]}
>

#### Request

A new job with cache is created by sending a HTTP POST message to https://api.bentley.com/contextcapture/jobs endpoint with the payload describing the job.

</TutorialSection>

<TutorialSection
  subSection={true}
  actions={[
    <CodeBlock
      language="json"
      code={`{
  "type": "Full",
  "name": "My CCCS job to be cached",
  "workspaceId": "WORKSPACE_ID",
  "inputs": [
    {
      "id": "IMAGECOLLECTION_RD_ID",
      "description": "Drone ImageCollection"
    },
    {
      "id": "CCORIENTATIONS_RD_ID",
      "description": "Drone CCOrientations"
    }
  ],
  "settings": {
    "meshQuality": "Extra",
    "processingEngines": 0,
    "outputs": [
      "OBJ"
    ],
    "cacheSettings":
    {
      "createCache": True
    }
  }
}`}
    />,
  ]}
>

#### Request Body

As you can see, we added in the settings a new section `cacheSettings` with the property `createCache` set to _True_.

At the end of the job, if it is successful, the cache will be automatically uploaded to _ContextCapture_ workspace reality data on _Reality Data_ - reality data id is the workspace id, in `{JOB_ID}/cache`.

<Alert type="informational">
  Note the JOB_ID created by this job. It will be useful later for using the
  cache.
</Alert>

</TutorialSection>

<TutorialSection>

## 3. Use a cached job

If you want to export your data to another format - 3SM for example, we can use the cached job to speed up the processing time.

</TutorialSection>

<TutorialSection
  subSection={true}
  actions={[
    <CodeBlock language='http' code={`POST https://api.bentley.com/contextcapture/jobs HTTP/1.1
Authorization: Bearer JWT_TOKEN
Content-Type: application/json`}
    />
  ]}
>

#### Request

A new job with using cache is created by sending a HTTP POST message to https://api.bentley.com/contextcapture/jobs endpoint with the payload describing the job.

</TutorialSection>

<TutorialSection
  subSection={true}
  actions={[
    <CodeBlock
      language="json"
      code={`{
  "type":"Full",
  "name":"My CCCS job using cache",
  "workspaceId":"WORKSPACE_ID",
  "inputs":[
    {
      "id":"IMAGECOLLECTION_RD_ID",
      "description":"Drone ImageCollection"
    },
    {
      "id":"CCORIENTATIONS_RD_ID",
      "description":"Drone CCOrientations"
    }
  ],
  "settings":{
    "meshQuality":"Extra",
    "processingEngines":0,
    "outputs":[
      "3SM"
    ],
    "cacheSettings":{
      "useCache":"JOB_ID_OF_CACHED_JOB"
    }
  }
}`}
    />,
  ]}
>

#### Request Body

As you can see, we added in the settings a section `cacheSettings` with the property `useCache` set to _JOB_ID_OF_CACHED_JOB_.
This tells _ContextCapture_ to download and use the cached job.
That way, your job will be faster, since geometry was cached and only need to be converted to _3SM_ format.

<Alert type="informational">
  It is possible to combine both properties in <code>cacheSettings</code>. For
  example you may want to use the cache of a <i>Calibration</i> job for a{' '}
  <i>Full</i> job, and have the result of this job cached for future exports.
</Alert>

</TutorialSection>

<ContinueLearningSection>

## Continue learning

Congratulations for completing the _ContextCapture_ cache tutorial! You should now be able to create and use cached job for faster processing.
To go further and use _ContextCapture_ to its maximum potential, you can check the following tutorials.

<TileList>
  <Tile
    name="Better calibration in ContextCapture"
    description="Learn how to specify calibration settings in ContextCapture, and download the result of a calibration"
    thumbnail="/unreal-docs-site/images/cccs-calibration-thumb.jpg"
    href="/tutorials/contextcapture-api-better-calibration"
  ></Tile>
  <Tile
    name="Better production in ContextCapture"
    description="Learn how to specify production settings in ContextCapture"
    thumbnail="/unreal-docs-site/images/cccs-production-thumb.jpg"
    href="/tutorials/contextcapture-api-better-production"
  ></Tile>
</TileList>

## More resources that you may like

<TileList>
  <ResourceTile
    title="Projects API"
    href="/apis/projects/"
    description="Project is necessary for using ContextCapture API. You can check its possibilities."
  />
  <ResourceTile
    title="Reality Data API"
    href="/apis/realitydata/"
    description="Reality Data API is necessary for uploading inputs for ContextCapture, and downloading outputs."
  />
</TileList>

</ContinueLearningSection>
