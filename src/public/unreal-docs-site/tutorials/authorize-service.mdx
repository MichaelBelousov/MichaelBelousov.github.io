export const metadata = {
  title: 'Authorize Service Application',
  tile: {
    name: 'Get Access Token with Service application',
    description: 'This tutorial will provide you information how to authorize.',
    href: '/tutorials/authorize-service/',
    durationInMinutes: 10,
    relatedApiIds: [],
  },
};

<Introduction 
  skillLevel="Basic" 
  durationInMinutes="10">

## Introduction

In this tutorial you will create **Service** application. Learn how **client_credential** flow works and how to get **access token** with it. And in the end we will double check if token is truly valid by making request to one of **iTwin Platforms API endpoint**.

</Introduction>

<TutorialSection>

## 1. Register an Service Application

#### What is Service Application?

**Service application** is designed to operate without user interaction (sometimes called two-legged OAuth) in order to access web-hosted resourced by using the identity of an application. Services run on a server where the source code or configuration of the application is not available to the public. This allows the use of a client secret when communicating with the authorization server to help improve security.

</TutorialSection>

<TutorialSection subSection actions={[<SignInButton />]}>

#### Sign in

To be able to register application you need to be Signed in.
If you are not already you can do that in action pane by clicking **Sign In** button or in the headers top right corner. 

</TutorialSection>

<TutorialSection
  subSection
  actions={data => [
    <CreateServiceAppButton
      tooltip="Register a basic Service App for this tutorial"
      allowedScopes={['users:read']}
      clientName="Authorize Service"
    >
    Register Application
    </CreateServiceAppButton>,
    <CodeBlock
      language="json"
      code={!data.clientId || !data.clientSecret || !data.scope
        ? undefined
        : JSON.stringify({
          client_id: data.clientId,
          client_secret: data.clientSecret,
          scope: data.scope,
        }, undefined, 2)}
    />
]}>

#### Register an Service Application

You will need to register an application to be able consume/use iTwin Platform APIs.
To make your tutorial more interactive please use the **Register Application** button.

After you click this button it will registers an client and will display its settings.
- **client_id**: This is the unique identifier for your application. It is displayed on the application details page as **Client ID**.
- **client_secret**: Secret that was created and shown first time you created an application. 
- **scope**: List of accesses granted to the application. Displayed on the application details page as **Scopes**.

<Alert type="informational">
  <b>For future use</b>: You can register applications in <a href="/my-apps" target="_blank">My apps</a> page.
  But it is not recommended for this tutorial
</Alert>

</TutorialSection>

<TutorialSection>

## 2. Get Access Token

#### What is access token?

An **Access Token** is token which contains a string that can be used to make authenticated requests to an API to access protect resources (in this case iTwin Platform APIs). The string has no meaning to the application using it, but represents that the user has authorized the application to access their account. The token is bounded by an appropriate lifetime, scopes, and other information that the server may require.

#### 2.1. Client credentials flow

**Client credentials** flow provides the ability for a web service (confidential client) to use it's own credentials, instead of impersonating a user, to authenticate when calling a web service. Permissions are granted directly to the application itself by an administrator. When the app presents a token to a resource, the resource enforces that the app itself has authorization to perform an action since there is no user involved in the authentication.

You can find more information [here](/apis/overview/authorization/#authorizingservicemachinetomachines), but it is more technical.

To sum up in simpler terms:
- No user interaction,
- No user context/information,
- You will use **client id** and **client secret** and **scope** to get access token.

</TutorialSection>

<TutorialSection
  subSection
  actions={(data) => [
    <Title>Request to Token endpoint</Title>,
    <HttpSample
      method="POST"
      url={`${data.authority}/connect/token`}
      headers={{
        'Content-Type': 'application/x-www-form-urlencoded'
      }}
      body={new URLSearchParams({
        client_id: data.clientId ?? 'CLIENT_ID',
        client_secret: data.clientSecret ?? 'CLIENT_SECRET',
        scope: data.scope ?? 'users:read',
        grant_type: 'client_credentials'
      }).toString()}
      saveResponseTo={"tokenResponse"}
      canSendRequest={data.clientId && data.clientSecret && data.scope}
    />
  ]}
>

#### 2.1.1. Request to Token endpoint

You need to call the token endpoint with the **Content-Type** header equal to **application/x-www-form-urlencoded**.

Request body (with [url encoded](https://www.w3schools.com/tags/ref_urlencode.ASP) characters):
- **client_id**: Identification that is generated when the application is created.  You can find it in the [My Apps](/my-apps) page. If you generated it during this tutorial you can find it in the first step.
- **client_secret**: Secret that was created and shown first time you created an application
- **scope**: Space separated scopes (in this tutorial: users:read)
- **grant_type**: **client_credentials** it indicates what flow is in use and client_credentials basically means that you will provide client_id and client_secret as credentials for fake user.

</TutorialSection>

<TutorialSection
  subSection
  actions={(data) => [
    <Title>Response from the Token endpoint</Title>,
    <CodeBlock
      language="json"
      code={JSON.stringify(
        data.tokenResponse
        || {
            "access_token": "JWT_TOKEN",
            "token_type": "Bearer",
            "expires_in": 3599
          }, undefined, 2)
      }
    />
  ]}
>

#### 2.1.2. Response

Response contains:
- **token_type**: **Bearer** this is part of Authorization header that is constructed like `Authorize: token_type access_token` you can read more [here](https://www.oauth.com/oauth2-servers/differences-between-oauth-1-2/bearer-tokens/).
- **access_token**: access token itself (in [JWT](https://jwt.io) format) that will be passed into **Authorize** header for api calls as **Bearer JWT_TOKEN**.
- **expires_in**: lifespan of access token in seconds.

</TutorialSection>

<TutorialSection>

## 3. Make the request

</TutorialSection>

<TutorialSection
  subSection
  actions={data => [
    <Title>Request to /users/me endpoint</Title>,
    <HttpSample
      method="GET"
      url={`${data.baseUrl}/users/me`}
      headers={{
        'Authorization': 'Bearer ' + (data.tokenResponse?.access_token ?? 'JWT_TOKEN'),
        'Accept': 'application/vnd.bentley.itwin-platform.v1+json'
      }}
      body={undefined}
      saveResponseTo={"me"}
      canSendRequest={data.tokenResponse}
    />
  ]}
>

#### 3.1. Make the request to /users/me endpoint

This request will show that newly created **access token** is valid and will show how to use it. `/users/me` endpoint would retrieve the logged in user's profile, but because authorization was done without user interaction it will contain 'fake' user information that is associated with this **Service** application.

</TutorialSection>

<TutorialSection
  subSection
  actions={data => [
    <Title>Response from /users/me endpoint</Title>,
    <CodeBlock
      language="json"
      code={JSON.stringify(
        data.me
        || {
          "user": {
            "displayName": "CLIENT_ID@apps.imsoidc.bentley.com",
            "givenName": "CLIENT_NAME",
            "surname": "LastName",
            "email": "CLIENT_ID@apps.imsoidc.bentley.com",
            "alternateEmail": "CLIENT_ID@apps.imsoidc.bentley.com",
            "city": null,
            "country": "US",
            "language": "EN",
            "createdDateTime": "2021-08-27T10:19:07.2510000Z"
          }
        }, undefined, 2)
      }
    />
  ]}
>

#### 3.2. Response explanation

Because service applications does not require user interaction it does not contain any user context or in simpler terms access token does not contain any user information and it gets assigned to 'fake' user and you can see details in this response. To give this application any additional access you need give extra roles, that can be done by administrator [more information about that](/apis/projects/#serviceapplications).

</TutorialSection>

<ContinueLearningSection>

</ContinueLearningSection>
