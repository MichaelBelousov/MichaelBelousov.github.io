export const metadata = {
  title: 'Exporting iModel to Unreal Datasmith as a combined mesh',
  tile: {
    name: 'Exporting iModel to Unreal Datasmith as a combined mesh',
    description:
      'Follow this tutorial to get iModel data into the Datasmith format as a combined mesh.',
    thumbnail: '/images/unreal-export-app-fullscreen.png',
    href: '/tutorials/itwin-unreal-export-combined-meshes',
    durationInMinutes: 20,
    relatedApiIds: ['itwin-unreal'],
    showInFirstSteps: false,
  },
};

<Introduction
  skillLevel="Basic"
  durationInMinutes="20"
  summaryImageSrc="/images/unreal-export-app-fullscreen-wide.png">

## Introduction

This tutorial will guide you through exporting your iTwin into the Datasmith format, and then importing that file directly
into Unreal Engine.

</Introduction>

<TutorialSection>

## Prerequisites

This tutorial assumes that you already have:

- [Unreal Engine 4.26.1](https://www.unrealengine.com/download) or later installed.
  - It is recommended to install Unreal before the iTwin Exporter for Datasmith app because
    the app requires some components that Unreal will install for you. If you want to install
    the exporter first anyway, the application will direct you to manually install the
    components that Unreal would install.
- the iTwin Exporter for Datasmith application installed.
  - The installer can be downloaded by clicking "Download now" [here](https://developer.bentley.com/unreal/), and then running the installer will complete the installation.
- [Visual Studio](https://visualstudio.microsoft.com/downloads) installed, and the "Game Development with C++" and ".NET desktop development" workloads installed.
- an Unreal project set up, you can use the
  [following guide](https://docs.unrealengine.com/4.27/en-US/Basics/Projects/Browser/) if you don't have one.
  - we recommend using the "Architecture, Engineering &amp; Construction" template so that the required Datasmith importer plugin is enabled.
    If you choose not to do this, you will need to enable that plugin yourself in your project's settings.

Make sure you install both "C++ Game Development" and ".NET desktop development" workloads for Visual Studio

<TitledImage
  src="/images/unreal-export-vs-workloads.png"
  alt="visual studio required workloads"
/>

</TutorialSection>

<TutorialSection>

## 1. Select your iModel

The iTwin Exporter for Datasmith opens to the sign in page. Hit the **Sign In button** to be prompted to log in through your
default browser. This will bring you to the **iModel Select Screen** of your most recent project.

To access other projects, select the project dropdown in the header and choose one of the recent projects or click
**See all my projects** to open the **Project Select Screen**.

Upon entering either of the select screens, the search box in the top-right is focused, so you can immediately type to filter
by name and find your iModel or project if you have several.

To see not only your most recent project's models, click the **See all your projects** option in the project dropdown

<TitledImage
  src="/images/unreal-export-see-all-projects.png"
  alt="see all projects button placement"
/>

</TutorialSection>

<TutorialSection>

## 2. Export your iModel as a combined-mesh

Once you've selected your project and found your iModel, you can perform an export immediately by clicking the **Export Button**.

<TitledImage
  src="/images/unreal-export-imodel-tile-quick-export.png"
  alt="quick 'export' button on the tile"
/>

This will bring up the **Advanced Export Dialog**, from which you can toggle on the **Combine All Meshes Toggle**, and then
press the **Confirm Export Button** at the bottom of the dialog.

<TitledImage
  src="/images/unreal-export-advanced-dialog-combined.png"
  alt="the advanced export dialog as it appears after using the quick export button"
/>

</TutorialSection>

<TutorialSection>

Simply press the button and use your system's save file dialog to choose under what name and where to save the resulting datasmith
content. Then wait for the export to complete, which is signified by a green success message appearing.

You may also click on your iModel card's image or its **View Button**
to enter the viewer, and can run a combined-mesh export with the left-most button in the top-left horizontal toolbar.

![in-viewer button](/images/unreal-export-in-viewer-combined-export-button.png)

</TutorialSection>

<TutorialSection subSection={true}>

### 2.1. Export Result

Once the export has completed,
you should have a file as you named it, like `myIModelName.udatasmith` and an `_Assets` folder with the same name as a prefix, for example `myIModelName_Assets`,
in your chosen export location. You should be able to find them in your file browser.

![Resulting Datasmith Files](/images/unreal-export-result-files-windows.png)

</TutorialSection>

<TutorialSection>

## 3. Install the iTwin Unreal Datasmith Plugin in your Unreal project

Now we can navigate back to the select screen and use the plugin installer button to install the iTwin Unreal Datasmith Plugin to our Unreal project.
Hit the **Home Button** in the top left, or use the project dropdown and press the **See all my projects** option to navigate back to the **Project Select Screen**.

<TitledImage
  src="/images/unreal-export-nav-home.png"
  alt="navigate home button placement"
/>

</TutorialSection>

<TutorialSection>

From the select screen, you can press the blue **Install Plugin Button** at the bottom of the application, and in the file dialog find the `.uproject` file belonging
to your Unreal project you created. Just choose that `.uproject` file and the plugin will be installed to that project.

<TitledImage
  src="/images/unreal-export-install-plugin-button.png"
  alt="install plugin button placement"
/>

Make sure to close and reopen the Unreal project if it is open. Upon opening the project for the first time since the installation,
it will prompt to rebuild the plugin. This is normal, and you should just allow it and wait for it to finish.
It may also say that it was designed for a different engine version, but you can ignore this and tell it to continue building.
If the rebuild fails, make sure you've met all of the [prerequisites](#prerequisites), since
it can fail if you have an unsupported Unreal Engine version or have not correctly installed the required Visual Studio workloads.

<img
  alt="rebuild prompt"
  src="/images/unreal-export-rebuild-prompt.png"
  class="sample-img-m"
/>

</TutorialSection>

<TutorialSection>

## 4. Import your iModel

In the Unreal Engine editor, use the Datasmith import button to open a file system dialog and select your `.udatasmith` file
to import it into the scene.

<TitledImage
  src="/images/unreal-export-editor-import-button.png"
  alt="unreal editor's datasmith import button placement"
/>

Choose a folder to place the content imported from Datasmith into in your content browser, then change any other import settings you need,
such as disabling lightmap UV generation if you will only be using dynamic lights to light your scene in Unreal.
Then just wait for the import process to finish.

</TutorialSection>

<TutorialSection subSection={true}>

### 4.1. Enable transformation animations if your scene is animated

If your scene has a schedule script or other animations, a [Level Sequence](https://docs.unrealengine.com/4.27/en-US/AnimatingObjects/Sequencer/Overview/)
asset will have been created to control the objects with transform animations. Due to limitations in the Datasmith API, you must manually add
the level sequence to the scene.

Open the `Animations` subfolder in the folder where you chose to import. The folder will only exist if you have transformation animations. You can drag and drop
the animation asset into the viewport to add it to the scene.

<TitledImage
  src="/images/unreal-export-anim-drag-drop.png"
  alt="drag-and-drop-level-sequence"
/>

</TutorialSection>

<TutorialSection subSection={true}>

Then, in the properties of the newly spawned Level Sequence Actor, toggle the **Auto Play** checkbox so that it is checked, which matches the default auto play
set for the [ScheduledActor](/unreal/integration/blueprint-api-reference#AScheduledActor) in your combined-mesh scene that controls the non-transformation animations.

![auto play](/images/unreal-export-set-autoplay.png)

</TutorialSection>

<TutorialSection>

## 5. Use a realistic material

Unreal's starter content comes with a few high-fidelity materials that we can use to test realistic materials on our iModel.
For a simple start to applying materials, open `StarterContent/Materials` in the content browser and drag and drop materials
onto your static meshes.

<TitledImage
  src="/images/unreal-export-start-materials.png"
  alt="starter content materials from unreal engine"
/>

</TutorialSection>

<TutorialSection>

We dragged and dropped some glass, concrete, metal, grass, wood, and cobblestone into our scene to see some high-fidelity materials.

Our sample scene would particularly have benefited from filtering out the tree and grass models and replacing them with more realistic or
animated ones, but that is something to explore in your Unreal project.

![scene after drag and drop](/images/unreal-export-high-quality-materials.png)

</TutorialSection>

<TutorialSection subSection={true}>

### 5.1. Opt-in to visibility animation

Materials must opt-in to visibility animation if using the combined-mesh export. You can edit materials attached to your
mesh by double clicking the material in the material slots of your static mesh actor's properties.

<TitledImage
  src="/images/unreal-export-material-slots.png"
  alt="material slots of combined mesh"
/>

</TutorialSection>

<TutorialSection subSection={true}>

Then select the material result node, if it is not already automatically selected as you open the editor, and set your
material's blend mode in the details panel to "masked", unless it is already "translucent" in which case leave it as is.
For more information on material blend modes in Unreal, see
[the Unreal Engine documentation](https://docs.unrealengine.com/4.27/en-US/RenderingAndGraphics/Materials/MaterialProperties/BlendModes/).

<TitledImage
  src="/images/unreal-export-set-material-blend-mode.png"
  alt="material editor blend mode dropdown"
/>

Finally, right click in open space to the left of the result node and use the search to place a `MaterialFunctionCall` node. In the details
panel, you can select a Material Function to use for this node, use `MF_SynchroVisibilityAnimate` which comes with the plugin.
Drag the output pin of the function to the **Opacity Mask** result pin (or **Opacity** if the material was translucent).

Now save and apply your material in the top left of the material editor, and your material will animate correctly with the visibility of the scene.

</TutorialSection>

<ContinueLearningSection>

## More resources that you may like

<TileList>
  <ResourceTile
    title="iTwin Exporter for Datasmith Documentation"
    href="/unreal/integration/documentation/"
    description="Extended functionality and workflow descriptions in iTwin Exporter for Datasmith"
  />
  <ResourceTile
    title="Importing Datasmith content into Unreal"
    href="https://docs.unrealengine.com/4.27/en-US/WorkingWithContent/Importing/Datasmith/HowTo/ImportingContent/"
    description="Unreal's documentation on importing datasmith content"
    isExternal={true}
  />
  {/* TODO: move this to the advanced export tutorial when it is added, due to constraints on dataprep */}
  <ResourceTile
    title="Get started with Unreal's Visual Dataprep"
    href="https://docs.unrealengine.com/4.27/en-US/WorkingWithContent/Importing/Dataprep/Overview/"
    description="Unreal's documentation on automating content processing with Visual Dataprep"
    isExternal={true}
  />
</TileList>

</ContinueLearningSection>
