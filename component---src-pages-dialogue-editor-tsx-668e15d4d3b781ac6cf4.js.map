{"version":3,"sources":["webpack:///./src/pages/DialogueEditor.tsx","webpack:///./src/utils/localFileManip.ts","webpack:///./node_modules/.pnpm/core-js@3.8.2/node_modules/core-js/modules/es.math.hypot.js","webpack:///./src/pages/DialogueEditor.module.scss","webpack:///./node_modules/.pnpm/@babel+runtime@7.12.5/node_modules/@babel/runtime/helpers/esm/defineProperty.js"],"names":["nodeTypeNames","downloadFile","opts","a","document","createElement","style","display","href","data","content","type","makeDataUrl","charset","encodeURI","fileName","download","appendEstimatedFileExtension","body","append","click","remove","uploadFile","Promise","resolve","reject","hiddenTree","innerHTML","input","children","onchange","file","files","blob","reader","FileReader","onloadend","ev","target","readyState","DONE","name","result","readAsText","readAsDataURL","err","initial","id","label","position","x","y","AppCtx","React","createContext","Proxy","get","Error","nodeTypes","dialogueEntry","props","appCtx","useContext","className","styles","dialogueEntryNode","handle","isConnectable","onChange","e","portrait","currentTarget","value","portraits","map","imageName","concat","portraitImg","src","alt","title","defaultValue","text","onClick","onDelete","deleteButton","edgeTypes","default","edgePath","getSmoothStepPath","markerEnd","getMarkerEnd","arrowHeadType","markerEndId","strokeWidth","d","DialogueEditor","useState","elements","setElements","onRightClick","useCallback","preventDefault","newId","Math","round","random","Number","MAX_SAFE_INTEGER","prev","newVal","copy","slice","index","findIndex","elem","removeElements","filter","clientX","clientY","Map","setPortraits","page","onContextMenu","toolbar","JSON","stringify","json","parse","Provider","graph","onConnect","params","addEdge","onElementsRemove","toRemove","deleteKeyCode","snapToGrid","snapGrid","onElementClick","_evt","isEdge","elems","$","$hypot","hypot","abs","sqrt","stat","forced","Infinity","NaN","value1","value2","arg","div","sum","i","aLen","arguments","length","larg","module","exports","_defineProperty","obj","key","Object","defineProperty","enumerable","configurable","writable"],"mappings":"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","file":"component---src-pages-dialogue-editor-tsx-668e15d4d3b781ac6cf4.js","sourcesContent":["import React from 'react'\nimport ReactFlow, {\n  addEdge,\n  Elements,\n  Handle,\n  NodeProps,\n  Node,\n  removeElements,\n  Controls,\n  MiniMap,\n  isEdge,\n  EdgeProps,\n  getBezierPath,\n  getMarkerEnd,\n  getSmoothStepPath,\n} from 'react-flow-renderer'\nimport styles from './DialogueEditor.module.scss'\nimport { downloadFile, uploadFile } from '../utils/localFileManip'\n\ninterface DialogueEntry {\n  portrait?: string\n  title: string\n  text: string\n}\n\ninterface DialogueEntryNodeData extends DialogueEntry {\n  /** shallow merges in a patch to the data for that entry */\n  onChange(newData: Partial<DialogueEntry>): void\n  onDelete(): void\n}\n\nconst initial: Elements<{} | DialogueEntryNodeData> = [\n  {\n    id: '1',\n    type: 'input',\n    data: {\n      label: 'entry',\n    },\n    position: { x: 540, y: 100 },\n  },\n]\n\ninterface AppState {\n  /** map of portrait file name to its [data]url */\n  portraits: Map<string, string>\n}\n\nconst AppCtx = React.createContext<AppState>(\n  new Proxy({} as AppState, {\n    get() {\n      throw Error('cannot consume null context')\n    },\n  })\n)\n\nconst DialogueEntryNode = (props: NodeProps<DialogueEntryNodeData>) => {\n  const appCtx = React.useContext(AppCtx)\n  return (\n    <div className={styles.dialogueEntryNode}>\n      <Handle\n        type=\"target\"\n        position=\"top\"\n        className={styles.handle}\n        isConnectable\n      />\n      <label>\n        portrait\n        <select\n          onChange={e =>\n            props.data.onChange({ portrait: e.currentTarget.value })\n          }\n        >\n          {[...appCtx.portraits]\n            .map(([imageName]) => (\n              <option value={imageName}>{imageName}</option>\n            ))\n            .concat(<option>none</option>)}\n        </select>\n        {props.data.portrait && (\n          <img\n            className={styles.portraitImg}\n            src={appCtx.portraits.get(props.data.portrait)}\n            alt={props.data.portrait}\n          />\n        )}\n      </label>\n      <label>\n        title\n        <input\n          className=\"nodrag\"\n          onChange={e =>\n            props.data.onChange({ ...props.data, title: e.currentTarget.value })\n          }\n          defaultValue={props.data.title}\n        />\n      </label>\n      <label>\n        text\n        <textarea\n          className=\"nodrag\"\n          onChange={e =>\n            props.data.onChange({ ...props.data, text: e.currentTarget.value })\n          }\n          defaultValue={props.data.text}\n        />\n      </label>\n      <button onClick={props.data.onDelete} className={styles.deleteButton}>\n        &times;\n      </button>\n      {/* will dynamically add handles potentially... */}\n      <Handle\n        type=\"source\"\n        position=\"bottom\"\n        className={styles.handle}\n        isConnectable\n      />\n    </div>\n  )\n}\n\nenum nodeTypeNames {\n  dialogueEntry = 'dialogueEntry',\n}\n\nconst nodeTypes = {\n  // TODO: could just make this the \"default\" node\n  [nodeTypeNames.dialogueEntry]: DialogueEntryNode,\n} as const\n\nconst CustomDefaultEdge = (props: EdgeProps) => {\n  const edgePath = getSmoothStepPath(props)\n  const markerEnd = getMarkerEnd(props.arrowHeadType, props.markerEndId)\n  return (\n    <>\n      <path\n        id={props.id}\n        style={{ ...props.style, strokeWidth: 3 }}\n        className=\"react-flow__edge-path\"\n        d={edgePath}\n        markerEnd={markerEnd}\n      />\n    </>\n  )\n}\n\nconst edgeTypes = {\n  // TODO: could just make this the \"default\" node\n  default: CustomDefaultEdge,\n} as const\n\nconst DialogueEditor = () => {\n  const [elements, setElements] = React.useState(initial)\n  const onRightClick = React.useCallback(\n    (e: React.MouseEvent) => {\n      e.preventDefault()\n      const newId = `${Math.round(Math.random() * Number.MAX_SAFE_INTEGER)}`\n      setElements(prev =>\n        prev.concat({\n          id: newId,\n          type: nodeTypeNames.dialogueEntry,\n          data: {\n            title: 'test title',\n            text: 'test text',\n            onChange: (newVal: Partial<DialogueEntryNodeData>) =>\n              setElements(prev => {\n                const copy = prev.slice()\n                const index = copy.findIndex(elem => elem.id === newId)\n                const elem = copy[index]\n                copy[index] = {\n                  ...elem,\n                  data: {\n                    ...elem.data,\n                    ...newVal,\n                  },\n                }\n                return copy\n              }),\n            onDelete: () =>\n              setElements(prev =>\n                removeElements(\n                  prev.filter(e => e.id === newId),\n                  prev\n                )\n              ),\n          },\n          position: { x: e.clientX - 0, y: e.clientY - 50 },\n        } as Node<DialogueEntryNodeData>)\n      )\n    },\n    [setElements]\n  )\n\n  const [portraits, setPortraits] = React.useState(new Map<string, string>())\n\n  return (\n    <div className={styles.page} onContextMenu={onRightClick}>\n      <div className={styles.toolbar}>\n        <button\n          onClick={() => {\n            downloadFile({\n              fileName: 'out.dialogue.json',\n              content: JSON.stringify(elements),\n            })\n          }}\n        >\n          Save\n        </button>\n        <button\n          onClick={async () => {\n            const file = await uploadFile({ type: 'text' })\n            const json = JSON.parse(file.content)\n            setElements(json)\n          }}\n        >\n          Load\n        </button>\n        <button\n          onClick={async () => {\n            const file = await uploadFile({ type: 'dataurl' })\n            setPortraits(prev => new Map([...prev, [file.name, file.content]]))\n          }}\n        >\n          Upload Portrait\n        </button>\n      </div>\n      {/* TODO: must memoize the context value */}\n      <AppCtx.Provider value={{ portraits }}>\n        <div className={styles.graph}>\n          <ReactFlow\n            elements={elements}\n            onConnect={params => setElements(e => addEdge(params, e))}\n            onElementsRemove={toRemove =>\n              setElements(e => removeElements(toRemove, e))\n            }\n            deleteKeyCode={46} /*DELETE key*/\n            snapToGrid\n            snapGrid={[15, 15]}\n            nodeTypes={nodeTypes}\n            edgeTypes={edgeTypes}\n            onElementClick={(_evt, elem) => {\n              if (isEdge(elem)) {\n                setElements(elems => removeElements([elem], elems))\n              }\n            }}\n          >\n            <Controls />\n            <MiniMap />\n          </ReactFlow>\n        </div>\n      </AppCtx.Provider>\n    </div>\n  )\n}\n\nexport default DialogueEditor\n","/** options for downloading a file that is created locally with some given string content */\ninterface DownloadFileOptsLocal {\n  fileName?: string\n  appendEstimatedFileExtension?: boolean\n  content: string\n}\n\ntype DownloadFileOpts = DownloadFileOptsLocal\n\nconst makeDataUrl = (\n  data: string,\n  type: string = 'text/plain',\n  charset: string = 'utf-8'\n) => {\n  return `data:${type};charset=${charset},${encodeURI(data)}`\n}\n\nconst mimetypeToExtensionMap: { [k: string]: string } = {\n  'text/csv': 'csv',\n  'application/zip': 'zip',\n}\n\nexport const downloadFile = async (opts: DownloadFileOpts) => {\n  const a = document.createElement('a')\n  a.style.display = 'none'\n  let contentType: string | undefined\n  a.href = makeDataUrl(opts.content)\n  if (opts.fileName) a.download = opts.fileName\n  if (opts.appendEstimatedFileExtension && contentType) {\n    a.download = `${a.download}.${mimetypeToExtensionMap[contentType] || 'txt'}`\n  }\n  document.body.append(a)\n  a.click()\n  a.remove()\n}\n\n/** prompt the user to upload a file, currenlty only supports text */\nexport const uploadFile = async (opts: { type: 'text' | 'dataurl' }) => {\n  const result = await new Promise<{ name: string; content: string }>(\n    (resolve, reject) => {\n      // should probably just keep this available at all times\n      const hiddenTree = document.createElement('div')\n      hiddenTree.style.display = 'none'\n      hiddenTree.innerHTML = `<input type=\"file\" id=\"temp-upload\" />`\n      const input = hiddenTree.children[0] as HTMLInputElement\n      input.onchange = function() {\n        try {\n          const [file] = input.files\n          const blob = file\n          const reader = new FileReader()\n          reader.onloadend = function(ev) {\n            if (ev.target.readyState === FileReader.DONE) {\n              resolve({ name: file.name, content: ev.target.result as string })\n            }\n          }\n          if (opts.type === 'text') {\n            reader.readAsText(blob, 'utf8')\n          } else {\n            reader.readAsDataURL(blob)\n          }\n        } catch (err) {\n          reject(err)\n        }\n      }\n      input.click()\n    }\n  )\n  return result\n}\n\nexport default downloadFile\n","var $ = require('../internals/export');\n\nvar $hypot = Math.hypot;\nvar abs = Math.abs;\nvar sqrt = Math.sqrt;\n\n// Chrome 77 bug\n// https://bugs.chromium.org/p/v8/issues/detail?id=9546\nvar BUGGY = !!$hypot && $hypot(Infinity, NaN) !== Infinity;\n\n// `Math.hypot` method\n// https://tc39.es/ecma262/#sec-math.hypot\n$({ target: 'Math', stat: true, forced: BUGGY }, {\n  hypot: function hypot(value1, value2) { // eslint-disable-line no-unused-vars\n    var sum = 0;\n    var i = 0;\n    var aLen = arguments.length;\n    var larg = 0;\n    var arg, div;\n    while (i < aLen) {\n      arg = abs(arguments[i++]);\n      if (larg < arg) {\n        div = larg / arg;\n        sum = sum * div * div + 1;\n        larg = arg;\n      } else if (arg > 0) {\n        div = arg / larg;\n        sum += div * div;\n      } else sum += arg;\n    }\n    return larg === Infinity ? Infinity : larg * sqrt(sum);\n  }\n});\n","// extracted by mini-css-extract-plugin\nmodule.exports = {\"toolbar\":\"DialogueEditor-module--toolbar--2WdIZ\",\"graph\":\"DialogueEditor-module--graph--1_z-x\",\"deleteButton\":\"DialogueEditor-module--deleteButton--3ZPhz\",\"dialogueEntryNode\":\"DialogueEditor-module--dialogueEntryNode--gdaLP\",\"handle\":\"DialogueEditor-module--handle--2Tk3p\",\"portraitImage\":\"DialogueEditor-module--portraitImage--3zG46\"};","export default function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}"],"sourceRoot":""}